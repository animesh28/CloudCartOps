pipeline {
    agent any
    
    environment {
        DOCKER_HUB_REPO = 'anisingh28'
        IMAGE_PREFIX = 'cloudcartops'
        K8S_NAMESPACE = 'cloudcart'
        GIT_COMMIT_SHORT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
        BUILD_TAG = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}-${GIT_COMMIT_SHORT}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git rev-parse HEAD'
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh '''
                        echo "Starting services with docker compose..."
                        docker compose up -d --build
                        
                        echo "Waiting for infrastructure services..."
                        for svc in cloudcart-postgres cloudcart-redis cloudcart-kafka; do
                            until [ "$(docker inspect --format='{{.State.Health.Status}}' $svc 2>/dev/null)" == "healthy" ]; do
                                echo "Waiting for $svc..."
                                sleep 2
                            done
                            echo "✓ $svc is healthy!"
                        done
                        
                        echo "Waiting for API and Frontend endpoints..."
                        services=(
                            "api-gateway:http://localhost:3000/health"
                            "user-service:http://localhost:8001/health"
                            "product-service:http://localhost:8002/health"
                            "order-service:http://localhost:8003/health"
                            "chaos-service:http://localhost:8004/health"
                            "frontend:http://localhost:3001/"
                        )
                        
                        for service in "${services[@]}"; do
                            name="${service%%:*}"
                            url="${service#*:}"
                            echo "Waiting for $name ($url)..."
                            until curl -s -f $url > /dev/null 2>&1; do
                                sleep 2
                            done
                            echo "✓ $name is ready!"
                        done
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            parallel {
                stage('User Service Tests') {
                    steps {
                        sh 'docker compose exec -T user-service bash -c "cd /app && python -m pytest tests/test_users.py -v --tb=short"'
                    }
                }
                stage('Product Service Tests') {
                    steps {
                        sh 'docker compose exec -T product-service bash -c "cd /app && python -m pytest tests/test_products.py -v --tb=short"'
                    }
                }
                stage('Chaos Service Tests') {
                    steps {
                        sh 'docker compose exec -T chaos-service bash -c "cd /app && python -m pytest tests/test_chaos.py -v --tb=short"'
                    }
                }
                stage('Notification Worker Tests') {
                    steps {
                        sh 'docker compose exec -T notification-worker bash -c "cd /app && python -m pytest tests/test_worker.py -v --tb=short"'
                    }
                }
                stage('Order Service Tests') {
                    steps {
                        sh 'docker compose exec -T order-service sh -c "cd /app && go test ./tests/... -v"'
                    }
                }
                stage('API Gateway Tests') {
                    steps {
                        sh 'docker compose exec -T api-gateway sh -c "cd /app && npm test"'
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                script {
                    sh '''
                        chmod +x tests/app_scenarios.sh
                        ./tests/app_scenarios.sh
                    '''
                }
            }
        }
        
        stage('Cleanup Test Environment') {
            steps {
                sh 'docker compose down -v'
            }
        }
        
        stage('Build Images') {
            parallel {
                stage('API Gateway') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-api-gateway:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-api-gateway:latest \
                                    ./services/api-gateway
                            """
                        }
                    }
                }
                stage('User Service') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-user-service:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-user-service:latest \
                                    ./services/user-service
                            """
                        }
                    }
                }
                stage('Product Service') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-product-service:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-product-service:latest \
                                    ./services/product-service
                            """
                        }
                    }
                }
                stage('Order Service') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-order-service:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-order-service:latest \
                                    ./services/order-service
                            """
                        }
                    }
                }
                stage('Chaos Service') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-chaos-service:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-chaos-service:latest \
                                    ./services/chaos-service
                            """
                        }
                    }
                }
                stage('Notification Worker') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-notification-worker:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-notification-worker:latest \
                                    ./services/notification-worker
                            """
                        }
                    }
                }
                stage('Metrics Generator') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-metrics-generator:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-metrics-generator:latest \
                                    ./services/metrics-generator
                            """
                        }
                    }
                }
                stage('Frontend') {
                    steps {
                        script {
                            sh """
                                docker build -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-frontend:${BUILD_TAG} \
                                    -t ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-frontend:latest \
                                    ./services/frontend
                            """
                        }
                    }
                }
            }
        }
        
        stage('Security Scan') {
            parallel {
                stage('Scan API Gateway') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-api-gateway:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan User Service') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-user-service:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Product Service') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-product-service:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Order Service') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-order-service:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Chaos Service') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-chaos-service:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Notification Worker') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-notification-worker:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Metrics Generator') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-metrics-generator:${BUILD_TAG}
                        """
                    }
                }
                stage('Scan Frontend') {
                    steps {
                        sh """
                            trivy image --severity CRITICAL,HIGH --exit-code 0 \
                                ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-frontend:${BUILD_TAG}
                        """
                    }
                }
            }
        }
        
        stage('Push Images') {
            when {
                branch 'main'
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                        
                        def services = [
                            'api-gateway',
                            'user-service',
                            'product-service',
                            'order-service',
                            'chaos-service',
                            'notification-worker',
                            'metrics-generator',
                            'frontend'
                        ]
                        
                        services.each { service ->
                            sh """
                                docker push ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-${service}:${BUILD_TAG}
                                docker push ${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-${service}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('Deploy Infrastructure') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        cd k8s
                        
                        echo "Creating namespace..."
                        kubectl apply -k base/namespace
                        
                        echo "Deploying PostgreSQL..."
                        kubectl apply -k base/postgres
                        kubectl wait --for=condition=ready pod -l app=postgres -n ${K8S_NAMESPACE} --timeout=300s || true
                        
                        echo "Deploying Redis..."
                        kubectl apply -k base/redis
                        
                        echo "Deploying Kafka and Zookeeper..."
                        kubectl apply -k base/kafka
                        kubectl wait --for=condition=ready pod -l app=kafka -n ${K8S_NAMESPACE} --timeout=300s || true
                        
                        echo "Deploying Vault..."
                        kubectl apply -k base/vault
                        kubectl wait --for=condition=ready pod -l app=vault -n ${K8S_NAMESPACE} --timeout=300s || true
                        
                        echo "Initializing Vault with secrets..."
                        chmod +x scripts/init-vault.sh
                        ./scripts/init-vault.sh all || echo "Vault already initialized"
                        
                        echo "Infrastructure deployment complete!"
                    """
                }
            }
        }
        
        stage('Deploy Applications') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        cd k8s
                        
                        echo "Deploying/Updating API Gateway..."
                        kubectl set image deployment/api-gateway api-gateway=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-api-gateway:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/api-gateway
                        
                        echo "Deploying/Updating User Service..."
                        kubectl set image deployment/user-service user-service=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-user-service:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/user-service
                        
                        echo "Deploying/Updating Product Service..."
                        kubectl set image deployment/product-service product-service=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-product-service:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/product-service
                        
                        echo "Deploying/Updating Order Service..."
                        kubectl set image deployment/order-service order-service=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-order-service:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/order-service
                        
                        echo "Deploying/Updating Chaos Service..."
                        kubectl set image deployment/chaos-service chaos-service=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-chaos-service:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/chaos-service
                        
                        echo "Deploying/Updating Notification Worker..."
                        kubectl set image deployment/notification-worker notification-worker=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-notification-worker:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/notification-worker
                        
                        echo "Deploying/Updating Metrics Generator..."
                        kubectl set image deployment/metrics-generator metrics-generator=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-metrics-generator:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/metrics-generator
                        
                        echo "Deploying/Updating Frontend..."
                        kubectl set image deployment/frontend frontend=${DOCKER_HUB_REPO}/${IMAGE_PREFIX}-frontend:${BUILD_TAG} -n ${K8S_NAMESPACE} || \\
                        kubectl apply -k base/frontend
                    """
                }
            }
        }
        
        stage('Deploy Monitoring') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        cd k8s
                        
                        echo "Deploying Prometheus..."
                        kubectl apply -k base/prometheus
                        
                        echo "Configuring Ingress..."
                        kubectl apply -f base/common/ingress.yaml
                    """
                }
            }
        }
        
        stage('Wait for Rollout') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        echo "Waiting for deployments to complete..."
                        kubectl rollout status deployment/api-gateway -n ${K8S_NAMESPACE} --timeout=300s
                        kubectl rollout status deployment/user-service -n ${K8S_NAMESPACE} --timeout=300s
                        kubectl rollout status deployment/product-service -n ${K8S_NAMESPACE} --timeout=300s
                        kubectl rollout status deployment/order-service -n ${K8S_NAMESPACE} --timeout=300s
                        kubectl rollout status deployment/frontend -n ${K8S_NAMESPACE} --timeout=300s
                        
                        echo "All deployments rolled out successfully!"
                    """
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh """
                        echo "Running smoke tests..."
                        kubectl wait --for=condition=ready pod -l app=api-gateway -n ${K8S_NAMESPACE} --timeout=300s
                        
                        POD=\\$(kubectl get pod -l app=api-gateway -n ${K8S_NAMESPACE} -o jsonpath='{.items[0].metadata.name}')
                        kubectl exec -n ${K8S_NAMESPACE} \\$POD -- wget -q -O- http://localhost:3000/health || exit 1
                        
                        echo "✓ API Gateway health check passed!"
                        echo "✓ Smoke tests completed successfully!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "=========================================="
                echo "CI/CD Pipeline completed successfully!"
                echo "=========================================="
                echo "Branch: ${env.BRANCH_NAME}"
                echo "Build: ${env.BUILD_NUMBER}"
                echo "Commit: ${GIT_COMMIT_SHORT}"
                echo "Image Tag: ${BUILD_TAG}"
                echo ""
                
                if (env.BRANCH_NAME == 'main') {
                    sh """
                        echo "Pod Status:"
                        kubectl get pods -n ${K8S_NAMESPACE}
                        
                        echo ""
                        echo "Service Status:"
                        kubectl get svc -n ${K8S_NAMESPACE}
                        
                        echo ""
                        echo "Ingress Status:"
                        kubectl get ingress -n ${K8S_NAMESPACE}
                        
                        echo ""
                        echo "Access Points:"
                        echo "  - Frontend: http://cloudcart.local"
                        echo "  - API: http://cloudcart.local/api"
                        echo "  - Prometheus: http://prometheus.cloudcart.local"
                        echo "  - Vault: http://vault.cloudcart.local"
                    """
                }
            }
        }
        failure {
            script {
                echo "=========================================="
                echo "CI/CD Pipeline failed!"
                echo "=========================================="
                
                sh """
                    echo "Showing service logs on failure..."
                    docker compose logs --tail=100 || true
                """
                
                if (env.BRANCH_NAME == 'main') {
                    sh """
                        echo ""
                        echo "K8s Pod Status:"
                        kubectl get pods -n ${K8S_NAMESPACE} || true
                        
                        echo ""
                        echo "Recent K8s Events:"
                        kubectl get events -n ${K8S_NAMESPACE} --sort-by='.lastTimestamp' | tail -20 || true
                        
                        echo ""
                        echo "API Gateway Logs:"
                        kubectl logs -n ${K8S_NAMESPACE} -l app=api-gateway --tail=50 || true
                    """
                }
            }
        }
        always {
            sh 'docker compose down -v || true'
            cleanWs()
        }
    }
}
